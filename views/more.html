<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="page-view-size" content="1280*720">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="../style/common.css"/>
    <link rel="stylesheet" type="text/css" href="../style/more.css"/>
    <title>更多内容</title>
</head>

<body>
<div id="subject">
    <img src="" alt="logo"/>
</div>
<div id="more_page">
    <div id="more_page_item_0" class="more_page_item" style="left: 6px;">
        <div id="more_page_item_img_0" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_0" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_1" class="more_page_item" style="left: 302px;">
        <div id="more_page_item_img_1" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_1" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_2" class="more_page_item" style="left: 598px;">
        <div id="more_page_item_img_2" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_2" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_3" class="more_page_item" style="left: 894px;">
        <div id="more_page_item_img_3" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_3" class="more_page_item_text"></div>
    </div>
    <div id="more_page_item_4" class="more_page_item" style="left: 6px; top: 250px;">
        <div id="more_page_item_img_4" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_4" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_5" class="more_page_item" style="left: 302px; top: 250px;">
        <div id="more_page_item_img_5" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_5" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_6" class="more_page_item" style="left: 598px; top: 250px;">
        <div id="more_page_item_img_6" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_6" class="more_page_item_text"></div>
    </div>

    <div id="more_page_item_7" class="more_page_item" style="left: 894px; top: 250px;">
        <div id="more_page_item_img_7" class="more_page_item_img">
            <img alt="item_img" src="" height="202" width="268"/>
        </div>
        <div id="more_page_item_text_7" class="more_page_item_text"></div>
    </div>

    <div id="more_page_index_img">
        <div id="more_page_index">
        </div>
    </div>
</div>

<!--底部-->
<div id="weather-forecast"></div>
<div id="intro-btn-usage"></div>

<div id="self_ad_focus">
    <table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">
        <tbody>
        <tr>
            <td width="10" height="10"
                style="background:url(../images/focus_lt.png) no-repeat;"></td>
            <td style="background:url(../images/focus_t.png) repeat-x;"></td>
            <td width="10" style="background:url(../images/focus_rt.png) no-repeat;"></td>
        </tr>
        <tr>
            <td style="background:url(../images/focus_l.png) repeat-y;"></td>
            <td>&nbsp;</td>
            <td style="background:url(../images/focus_r.png) repeat-y;"></td>
        </tr>
        <tr>
            <td width="10" height="10" style="background:url(../images/focus_lb.png) no-repeat;"></td>
            <td style="background:url(../images/focus_b.png) repeat-x;"></td>
            <td style="background:url(../images/focus_rb.png) no-repeat;"></td>
        </tr>
        </tbody>
    </table>
</div><!-- self_ad_focus -->
<div id="debug-message"></div>

</body>

<script type="application/javascript" src="../script/async.js"></script>
<script type="application/javascript" src="../script/utility.js"></script>
<script type="application/javascript" src="../script/keyEvent.js"></script>
<script type="text/javascript">

    function MoreHelper() {
        this.perRowsInPage = 2;         //  每页最多显示两行
        this.perItemsInRow = 4;         //  每行最多显示四项
        this.focusPosX = 0;           //  默认定位在第一行第一项
        this.focusPosY = 0;
        this.pageIndex = 0;
        this.resourceId = 0;
        this.totalPages = 0;
        this.displayItemArray = [];
        this.displayItemArray[0] = [];
        this.displayItemArray[1] = [];

        this.init = function (resourceId, pageIndex) {
//            var data = [
//                {assetid: 111, img: "../images/post-2.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21},
//                {assetid: 111, img: "../images/post-1.jpg", title: "我我我我我我我我我我我", flag: 0, id: 21}
//            ];

            var that = this,
                i,
                count = this.perRowsInPage * this.perItemsInRow,
                postman = new Postman(),
                _url = paramObj.serverUrl +
                    "queryTitleListMobile.shtml?resourceId=" + resourceId + "&num=" + count + "&cur_page=" + pageIndex,
                _focusNode = document.getElementById("self_ad_focus");

            this.focusPosX = 0;           //  默认定位在第一行第一项
            this.focusPosY = 0;

            // 初始化 - 隐藏所有节点
            _focusNode.style.visibility = "hidden";
            for (i = 0; i < count; i++) {
                document.getElementById("more_page_item_" + i).style.visibility = "hidden";
            }

//            this.addItems(data);
//            this.focusOn();

            if (resourceId !== "") {
                document.getElementById("debug-message").innerHTML += "<br/>" + " URL ==> " + _url;

                postman.createXmlHttpRequest(
                    function (html) {
                        var json = eval('(' + html + ')');

                        if ("1" === json.code || 1 === json.code) {
                            if (json.dataArray.length > 0) {
                                that.resourceId = resourceId;
                                that.pageIndex = pageIndex;
                                that.totalPages = json.total_page;
                                document.getElementById("more_page_index").innerHTML = that.pageIndex + " / " + that.totalPages;
                                that.addItems(json.dataArray);
                                that.focusOn();
                            }
                        }
                    },
                    function (error) {
                        document.getElementById("debug-message").innerHTML += "<br/>" + " Error ==> " + error;
                    });
                postman.sendRequest(
                    "GET",
                    _url,
                    null
                );
            }
        };

        this.addItems = function (data) {
            var i,
                max = this.perRowsInPage * this.perItemsInRow,
                length;

            for (i = 0, length = data.length; i < length && i < max; i++) {
                if (i < this.perItemsInRow) {
                    this.displayItemArray[0][i] = {
                        left: 60 + (i * 296),
                        top: 153,
                        width: 273,
                        height: 206,
                        flag: parseInt(data[i].flag),
                        assetid: data[i].assetid,
                        img: data[i].img,
                        title: data[i].title,
                        id: data[i].id
                    }
                } else {
                    this.displayItemArray[1][(i - this.perItemsInRow)] = {
                        left: 60 + ((i - this.perItemsInRow) * 296),
                        top: 153 + 237,
                        width: 273,
                        height: 206,
                        flag: parseInt(data[i].flag),
                        assetid: data[i].assetid,
                        img: data[i].img,
                        title: data[i].title,
                        id: data[i].id
                    }
                }
                /* end of if */
                document.getElementById("more_page_item_text_" + i).innerHTML = data[i].title;
//                showTitleForMarquee(data[i].title, document.getElementById("more_page_item_text_" + i), 10);
//                $("more_page_item_img_" + i).children[0].src = paramObj.imgUrl + data[i].img;
                document.getElementById("more_page_item_img_" + i).children[0].src = paramObj.imgUrl + data[i].img;
                document.getElementById("debug-message").innerHTML += "<br/>" + "set item image src: " + paramObj.imgUrl + data[i].img;
                document.getElementById("debug-message").innerHTML += "<br/>" + "width: " + document.getElementById("more_page_item_img_" + i).children[0].width + "height: " + document.getElementById("more_page_item_img_" + i).children[0].height;
                document.getElementById("more_page_item_" + i).style.visibility = "visible";
            }
            /* end of for */
        };

        this.focusOn = function () {
            var _num = 0,
                _focusNode = document.getElementById("self_ad_focus");

            if (this.displayItemArray[0].length > 0) {
                _focusNode.style.visibility = "visible";
                _focusNode.style.left = this.displayItemArray[this.focusPosY][this.focusPosX].left + "px";
                _focusNode.style.top = this.displayItemArray[this.focusPosY][this.focusPosX].top + "px";
                _focusNode.style.width = this.displayItemArray[this.focusPosY][this.focusPosX].width + "px";
                _focusNode.style.height = this.displayItemArray[this.focusPosY][this.focusPosX].height + "px";

                _num = this.focusPosY * this.perItemsInRow + this.focusPosX;

                showTitleForMarquee(this.displayItemArray[this.focusPosY][this.focusPosX].title, document.getElementById("more_page_item_text_" + _num), 10);
            }
        };

        this.focusOut = function () {
            var _num = 0;

            _num = this.focusPosY * this.perItemsInRow + this.focusPosX;
            if (this.displayItemArray[0].length > 0) {
                document.getElementById("more_page_item_text_" + _num).innerHTML = this.displayItemArray[this.focusPosY][this.focusPosX].title;
            }

        };

        this.changePage = function (_direction) {
            var index;

            index = this.pageIndex + _direction;
            if (index >= 1 && index <= this.totalPages) {
                document.getElementById("debug-message").innerHTML += "<br/>" + "changePage ==> direction = " + _direction + " | page index = " + index;
                this.init(this.resourceId, index);
            }
        };
    }

    function PageItemObj() {
        var that = this;

        MoreHelper.call(this);

        this.moveX = function (_direction) {
            this.focusOut();

            console.info("pageItemObj ==> moveX ==> direction = " + _direction);
            this.focusPosX += _direction;

            if (this.focusPosX >= 0 && this.focusPosX < this.displayItemArray[this.focusPosY].length) {

            } else if (this.focusPosX < 0) {
                this.focusPosX = that.displayItemArray[this.focusPosY].length - 1;
            } else {
                this.focusPosX = 0;
            }

            this.focusOn();
        };

        this.moveY = function (_direction) {
            var rows = 0;

            this.focusOut();

            this.focusPosY += _direction;

            if (this.displayItemArray[1].length > 0) {
                rows = 2;
            } else if (this.displayItemArray[0].length > 0) {
                rows = 1;
            }

            if (this.focusPosY >= 0 && this.focusPosY < rows) {

            } else if (this.focusPosY < 0) {
                this.focusPosY = rows - 1;
            } else {
                this.focusPosY = 0;
            }

            document.getElementById("debug-message").innerHTML += "<br/>" + " moveY ==> direction = " + _direction
                + " ==> focusX = " + this.focusPosX
                + " ==> focusY = " + this.focusPosY;


            this.focusOn();

        };


        this.doSelect = function (subject) {
            var _link = "";

            document.getElementById("debug-message").innerHTML += "<br/>"
                + "flag ==> " + that.displayItemArray[that.focusPosY][that.focusPosX].flag
                + " img ==>" + that.displayItemArray[that.focusPosY][that.focusPosX].img;

            if (that.displayItemArray[that.focusPosY][that.focusPosX].flag === 0 ||
                that.displayItemArray[that.focusPosY][that.focusPosX].flag === "0") {         // 文字列表项
                if (that.displayItemArray[that.focusPosY][that.focusPosX].img === "") {
                    _link = "text.html?itemId=" + that.displayItemArray[that.focusPosY][that.focusPosX].id + "&subject=" + subject + "&backUrl=" + encodeURIComponent(window.location.href);
                } else {
                    _link = "list.html?itemId=" + that.displayItemArray[that.focusPosY][that.focusPosX].id + "&subject=" + subject + "&backUrl=" + encodeURIComponent(window.location.href);
                }
            }

            document.getElementById("debug-message").innerHTML += "<br/>" + "Go to link => " + _link;
            window.location.href = _link;
        };
    }

    function Controller() {
        var that = this;

        Assistant.call(this);
        this.backUrl = "";
        this.subject = "";

        this.init = function () {

            transferStation.record();       // 记录返回参数
            that.backUrl = transferStation.backUrl;
            that.subject = transferStation.subject;
            document.getElementById("subject").children[0].src = '../images/' + transferStation.subject + '/' + transferStation.subject + '_logo.png';
            pageItemObj.init(transferStation.resourceId, 1);
//            pageItemObj.focusOn();
        };

        this.focusOn = function () {
            pageItemObj.focusOn();
        };

        this.focusOut = function () {
            pageItemObj.focusOut();
        };

        this.moveX = function (_direction) {
            console.info("==>   moveX");
            pageItemObj.moveX(_direction);
        };

        this.moveY = function (_direction) {
            pageItemObj.moveY(_direction);
        };

        this.changePage = function (_num) {
            pageItemObj.changePage(_num);
        };

        this.doSelect = function () {
            pageItemObj.doSelect(that.subject);
        };

        this.doBack = function () {
            window.location.href = that.backUrl;
        }
    }

    var
        pageItemObj = new PageItemObj(),
        controller = new Controller();

    function grabEvent(_event) {

        var code = Event(_event);

        switch (code) {
//            case "KEY_NUMBER1":
//                console.info("KEY_NUMBER1");
//                controller.toggle();
//                return false;
            case "KEY_UP": //
                controller.moveY(-1);
                return false;
            case "KEY_DOWN": //
                controller.moveY(1);
                return false;
            case "KEY_LEFT": //
                controller.moveX(-1);
                return false;
            case "KEY_RIGHT": //
                controller.moveX(1);
                return false;
            case "KEY_PAGE_UP": //
                controller.changePage(-1);
                return false;
            case "KEY_PAGE_DOWN": //
                controller.changePage(1);
                return false;
            case "KEY_SELECT": //
                controller.doSelect();
                return false;
            case "KEY_EXIT":
            case "KEY_BACK":
                controller.doBack();
                return false;
            default:
                break;
        }
    }
    document.onkeydown = grabEvent;
    window.onload = controller.init;

</script>

</html>

