<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="page-view-size" content="1280*720"/>
    <title>视频播放</title>
</head>

<body style="position: absolute; left: 0; top: 0; margin: 0; background: #000000;">

<!--加载图标-->
<div id="loadingImg" style="position:absolute; left:579px; top:299px; width:121px; height:121px; visibility: hidden">
    <img src="../images/loadingIcon.gif" width="121" height="121"/>
</div>

<div id="debug-message" style="
    position: absolute;
    top: 10px;
    left: 30px;
    width: 1024px;
    word-wrap: break-word;
    font-size: 15px;
    z-index: 9999999;
    color: azure;
    overflow: scroll;
    display: none;">

</div>

</body>


<script type="application/javascript" src="../script/async.js"></script>
<script type="application/javascript" src="../script/utility.js"></script>
<script type="application/javascript" src="../script/keyEvent.js"></script>
<script type="application/javascript">
    var controller = new Controller();


    function Controller() {
        var that = this;

        Assistant.call(this);

        this.assetId = "";
        this.backUrl = "";
        this.ip = GlobalVarManager.getItemStr("ip");
        this.port = GlobalVarManager.getItemStr("port");
        this.account = GlobalVarManager.getItemStr("account");
        this.client = CAManager.cardSerialNumber;

//        this.ip = '10.215.0.12';
//        this.port = '8080';
//        this.account = '8350310392603009';
//        this.client = '8350310392603009';

        this.init = function () {
            var requestUrl,
                data,
                postman = new Postman();


            transferStation.record();

            that.assetId = transferStation.assetId;
            that.backUrl = transferStation.backUrl;

            document.getElementById("debug-message").innerHTML += "<br/>" + "assetId: " + that.assetId + ", backUrl:" + that.backUrl;

//            getDetailData(that.assetId);

            // 获取视频相关参数
            postman.createXmlHttpRequest(getParametersSuccess, getParametersFail);

            requestUrl = "http://" + that.ip + ":" + that.port + "/GetItemData";
            data = "<?xml version='1.0' encoding='UTF-8' standalone='yes'?><GetItemData titleAssetId='" + that.assetId
                + "' portalId='1' client='" + that.client
                + "' account='" + that.account
                + "' languageCode='Zh-CN' profile='1'/>";
            document.getElementById("debug-message").innerHTML += "<br/>" + "URL ==> " + requestUrl;
            document.getElementById("debug-message").innerHTML += "<br/>" + "Data ==> " + encodeURI(data);

            postman.sendRequest(
                "POST",
                requestUrl,
                data);

        };

        this.playVideo = function (_video) {
            var requestUrl,
                data,
                postman = new Postman();

            document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     PlayVideo()";

            postman.createXmlHttpRequest(
                function (_response) {
                    document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     getVideoAddressSuccess";

                    var _data = parseDom(_response);
                    var _json = parseJson(_data.toJson());

                    document.getElementById("debug-message").innerHTML += "<br/>" + "Data  ==> " + _data;

                    if (typeof (_json) === "object" && _json !== null) {

                        var rtsp = _json.StartResponse[0].rtsp.split(";");
                        var serverId = rtsp[2].split(":");
                        var playUrl = rtsp[0] + ";" + rtsp[1] + ";" + serverId[0] + ":8080" + ";areacode=" + VOD.areaCode + ";client=" + CAManager.cardSerialNumber;
                        GlobalVarManager.setItemStr("vodPlayUrl", playUrl);
                        // playUrl
                        // rtsp://10.215.0.50:554/;purchaseToken=2264654112;serverID=10.215.0.12:8080;areacode=3069;client=8350310392603009

                        document.getElementById("debug-message").innerHTML += "<br/>" + "Video Play URL ==> " + playUrl;

                        var playIp = "http://vod.fjgdwl.com:80/gldb/NEW_UI/vodPlay/";   // 去vod播放的路径
                        var resumePoint = 0;
                        var _link = playIp + "vodPlay.htm?previewId=" + _json.StartResponse[0].previewAssetId +
                            "&startTime=" + _json.StartResponse[0].startTime + "&purchaseToken=" + _json.StartResponse[0].purchaseToken +
                            "&playCurrName=" + _video.titleFull + "&assetId=" + that.assetId +
                            "&rentDateTime=" + _video.RentalInfo[0].rentDateTime + "&providerId=" + _video.providerId +
                            "&displayRunTime=" + _video.displayRunTime + "&folderAssetId=" + _video.folderAssetId +
                            "&resumePoint=" + resumePoint + "&from=" + that.backUrl;

                        document.getElementById("debug-message").innerHTML += "<br/>" + "getVideoAddressSuccess ==> =" + _link;
                        window.location.href = _link;
                    }
                },
                function (error) {
                    document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     getVideoAddressFailed";
                    document.getElementById("debug-message").innerHTML += "<br/>" + error;
                }
            );

            requestUrl = "http://" + that.ip + ":" + that.port + "/SelectionStart";
            data = "<?xml version='1.0' encoding='UTF-8' standalone='yes'?><SelectionStart titleAssetId='" + that.assetId
                + "' folderAssetId='" + that.assetId
                + "' portalId='1'  client='" + that.client
                + "' account='" + that.account
                + "' serviceId='" + _video.serviceId + "'/>";

            document.getElementById("debug-message").innerHTML += "<br/>" + "URL ==> " + requestUrl;
            document.getElementById("debug-message").innerHTML += "<br/>" + "Data ==> " + encodeURI(data);

            postman.sendRequest(
                "POST",
                requestUrl,
                data
            );
        };

        this.doBack = function () {
            window.location.href = that.backUrl;
        }
    }

    function getParametersSuccess(_response) {
        var _key = "ItemData",
            _data,
            _json,
            _message = "",
            _errorCode;

        document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     getParametersSuccess()";
        document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     Response: " + _response;

        _data = parseDom(_response);
        _json = eval('(' + _data.toJson() + ')');
        document.getElementById("debug-message").innerHTML += "<br/>" + "  typeof ==> " + typeof (_json);

        if (typeof (_json) === "object" && _json !== null) {

            if (_key in _json) {
                controller.playVideo(_json.ItemData[0].SelectableItem[0]);     //
            } else {
                // 错误处理
                if ("NavServerResponse" in _json) {
                    _message = _json.NavServerResponse[0].debug;
                    _errorCode = _json.NavServerResponse[0].code;
                    document.getElementById("debug-message").innerHTML += "<br/>" + "Error - " + _errorCode + ", message:" + _message;
                } else {
                    document.getElementById("debug-message").innerHTML += "<br/>" + "获取数据失败";
                }
            }

        }
    }

    function getParametersFail(error) {
        document.getElementById("debug-message").innerHTML += "<br/>" + "  ==>     getParametersFail()";
        document.getElementById("debug-message").innerHTML += "<br/>" + error;
    }

    function grabEvent(_event) {

        var code = Event(_event);

        switch (code) {
            case "KEY_NUMBER1":
                console.info("KEY_NUMBER1");
                controller.toggle();
                return false;
            case "KEY_EXIT":
            case "KEY_BACK":
                controller.doBack();
                return false;
            default:
                break;
        }
    }
    document.onkeydown = grabEvent;
    window.onload = controller.init;

</script>
